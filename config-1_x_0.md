# Version 1.x.0

## Project config vs Client config

There are two types of configurations. The first one is client-level config, which typically lives in your git
repositories in the `Exofile.yml` file. Another config type is project-level config, which lives in the cloud.

There may be multiple client-level configs, but only one project-level config.

Some handlers may be defined in client-level config only, in project-level config only or in both config types. Each
handler documentation entry contains the information on which type of config is supported.

## Core entities

### Mount Point

Mount point is an identifier, which is used to connect the configuration with domain name

### Handler

Handler performs the actual work. Handlers are ordered by the `priority` field under the mount point, and are invoked
step-by-step.

### Rule

Each handler contains the `rule` block, which defines how handler should react on the request depending on its path,
query parameters, headers, etc. As a result of rule processing, the handler may be invoked, skipped, perform
static-response or throw the exception.

Example:

```yaml
rules:
  - filter:
      path: [ "none" ]
    action: next-handler
  - filter:
      path: [ "*" ]
    action: invoke
```

Filter is used to check if the rule should be applied to the request. Filter contains the following fields:

```yaml
filter:
  path: [ "segment1", "segment2" ]
  trailing-slash: require|allow|deny
  methods:
    - GET
    - POST
    - PUT
    - ...
  query-params:
    query-params:
      q1: "?"
      ..
```

### Path Matcher and trailing slash policy

Exogress treats patch segment as a first class citizen, so that you defined rules based on arrays of segments, not the
whole path matchers.

There are different kinds of segment(s) matchers available:

- Strict match. The simple string will be strictly matched
- Any segment. `?` symbol is used to match against any segment on the position
- Any number of segments. `*` is used when any number of segments is allowed. This symbol may be used only once in the
  path matcher.
- Choice. If the segment is an array, any of the provided values are allowed on the position
- Regular Expression. Segment starting and ending with `/` symbol is treated as a regular expression.

Array notation for path segments doesn't cover if path ends with `/` or not. `trailing-slash` is used for that. Possible
values are: `require`, `allow`, and `deny`


### Query Matcher

Query matchers are used to match the GET query parameters. They are mostly similar to path matchers, but have some
differences.

- Strict match. The simple string will be strictly matched
- Any segment. `?` symbol is used to match parameter value that doesn't contain `/` and exists
- Any number of segments. `*` is just like `?` but allows `/` symbol
- Choice. Any of the provided values are allowed on the position
- Regular Expression. Segment starting and eding with `/` symbol is treated as a regular excpression.
- `~` (yaml notation for nil). Optionally any value. Used only to capture the value, does not affects the filtering.

### Exception

Exogress uses the concept of exceptions, just like most of the modern programming languages. Configuration may
explicitly instruct Exogress servers to throw the exception, or it may occur due to the incorrect configuration file,
processing error, etc.

Exception name has the following form

```
segment1:segment2:segment3
```

Exception name represents the inheritance, when we read it from the left to the right.

For example:

```
proxy-error:upstream-unreachable:connection-rejected
```

means that this exception belongs to the exception class `proxy-error` and it's
subclass `proxy-error:upstream-unreachable`. This is useful in the the rescue blocks, so that we don't need to point all
possible exceptions which should lead, for example, to "Gateway Error" page, but just use the parent segment:

```yaml
rescue:
  - catch: "exception:proxy-error"
    action: respond
    status-code: 502
    static-response: bad-gateway
```

### Rescue

Rescue blocks are used to catch exceptions as well as to handle HTTP status codes, generated by the particular handler.

Rescue blocks are checked one-by-one according to the visibility rules.

Each item defined under the rescue block should contain the `catch` field. Exogress tries to match each catch field
against the thrown exception. There are two forms of the catch field:

```
exception:exception-segments
```

If the thrown exception equals to the one defined in catch field, or catch field contains the subclass of the thrown
exception, then the whole block is executed.

or

```
status-code:5xx
```

This rescue blocks are applied whe the response is successfuly generated, and we need to customize the behavior
depending on the resulting status code.

Status-code matcher may be in the one of the following forms:

- `"200"`
- `"200,201,202"`
- `"4xx"`
- `"505-510"`

Each rescue block should contain the `action` field. Allowed values are:

1. `respond` - respond with static-response
   ```yaml
    catch: "exception:proxy-error"
    action: respond
    static-response: "@server-unreachable"
   ```

2. `throw` - throw the exception.
   ```yaml
    catch: "status-code:429"
    action: throw
    exception: "api-error:rate-limited"
    date:
      backed: "api-server"
   ```

3. `next-handler` - move on to the next handler

### Static Response

It is often required that the server just responds with the predefined static-response.

Static responses may be defined in parameters, client or project config or just defined in the place where they are
required.

Example:

```yaml
---
version: 1.0.0
revision: 1
name: config
mount-points:
  default:
    handlers:
      dir:
        kind: pass-through
        priority: 10
        rules:
          - filter:
              path: [ "ref" ]
            action: respond
            static-response: it-works
          - filter:
              path: [ "embed" ]
            action: respond
            static-response:
              kind: redirect
              destination: "https://google.com/"
              redirect-type: moved-permanently
          - filter:
              path: [ "param" ]
            action: respond
            static-response: "@static-resp-param"
static-responses:
  it-works:
    kind: raw
    status-code: 200
    body:
      - content-type: text/html
        content: "<html><body>It works!</body></html>"
        engine: handlebars
```

### Scope of static-responses and catch blocks

`static-responses` and `rescue` blocks may be defined in both client and project level configs, on different levels:

- top-level
- mount-point
- handler

The visibility of the particular item depends on where it is defined. Generally, the visibility order is as follows:

1. Top-level Project config
2. Top-level Client config with the same config name
3. Mount Point Project config with the same mount point name
4. Mount Point client config with the same mount point name and config name
5. Handler Project config with the same handler and mount point name
6. Handler client config with the same mount point name and config name and a handler name

In other worlds, static responses defined in the Top-level Project config is visible to any configuration block in the
project configuration, while static responses defined on the mount-point level in client config will be visible on this
mount point defined in this client config and is invisible for other client configs or project configs.

The lookup priority is in backward direction. Exogress will start lookup in the most precise point and end-up on the
top-level project config.

This system allows having static responses with the same name with different content, as well as rescue blocks catching
the same exceptions, defined on different levels, with different behavior on different parts of the system.

## Config top-level keys

### version

?> introduced in 1.0.0

?> Client & Project

`version` field defines the minimum version that exogress client should support. The Patch version is always expected to
be 0. Since this page describes the major version 1, it should always be 1. It's recommended to bump the version when
new minor version is released.

### name

?> introduced in 1.0.0

?> Client only

Config name represents the peace of configuration, which is dynamically loaded into one or more Mount Points. There may
be multiple config names related to a single Mount Point, as well as a single config that works with numerous Mount
Points.

Name uniquely identifies the particular `Exofile.yml` content. Exogress servers will validate that multiple Clients with
the same `name` and `revision` announce exactly the same config.

### revision

?> introduced in 1.0.0

?> Client only

Revision is used to define how different Clients with the same config `name` are performing upgrades. Because the
same `name` and `revision` should represent the same config, one needs to bump the revision number so that system may
perform a rolling-upgrade. Otherwise, the new config will never be applied if at least one Client with the same
`name` is still online.

### mount-points

?> introduced in 1.0.0

?> Client & Project

A list of mount points where this config will load its handlers. A hash-map, where keys are mount points, and the values
are the mount point body.

### upstreams

?> introduced in 1.0.0

?> Client only

[comment]: <> (### handler)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (?> Client & Project)

[comment]: <> (Handler represents the particular step that Exogress edge server should perform. There are different kinds of handlers. Field `type` defines which handler should be used. There are a few common fields:)

[comment]: <> (- `base-path` and `replace-base-path`. See [URL Paths]&#40;/config-1_x_0?id=url-paths&#41;)

[comment]: <> (- `priority`. Gateway servers will apply handlers according to the priority. It starts from the smallest priority, moving to the larger values. Priority lives in a mount point, and the end ordering may include handlers from different configs.)

[comment]: <> (- `filters` see [Filters secions]&#40;/config-1_x_0?id=filters&#41;)

[comment]: <> (#### static-dir)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (?> Client only)

[comment]: <> (Serve the static directory from the computer where the exogress client is running.)

[comment]: <> (#### proxy)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (?> Client only)

[comment]: <> (Reverse proxy / Load Balancer handler. Forward requests to one of the defined [upstreams]&#40;/config-1_x_0?id=upstream&#41;)

[comment]: <> (### upstreams)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (?> Client only)

[comment]: <> (## Rules)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (?> Client & Project)

[comment]: <> (Rules may be defined on any handler— their goal is to provide behavior modifications on handler processing.)

[comment]: <> (Rules example:)

[comment]: <> (```yaml)

[comment]: <> (mount-points:)

[comment]: <> (  my-mount-point:)

[comment]: <> (    handlers:)

[comment]: <> (      backend:)

[comment]: <> (        kind: proxy)

[comment]: <> (        upstream: server)

[comment]: <> (        priority: 10)

[comment]: <> (        rules:)

[comment]: <> (          - filter:)

[comment]: <> (              path: ["static", "*"])

[comment]: <> (            action:)

[comment]: <> (              kind: next-handler)

[comment]: <> (          - filter:)

[comment]: <> (              path: ["*"])

[comment]: <> (            action:)

[comment]: <> (              kind: invoke)

[comment]: <> (```)

[comment]: <> (`path` field is the [path with possible wildcards]&#40;/config-1_x_0?id=wildcards&#41;)

[comment]: <> (Rules are processed from top to bottom. When the filter matches the requested one - the action is performed.)

[comment]: <> (There are a few types of actions:)

[comment]: <> (- `invoke`. Pass the request to the handler, where the rule is defined.)

[comment]: <> (- `next-handler`. Skip this handler and move on to the next one.)

[comment]: <> (- `none`. Just skip this rule and move on to the next one. Will later be used for request modifications.)

[comment]: <> (- `throw`. Throw the [exception]&#40;/config-1_x_0?id=exceptions&#41;.)

[comment]: <> (- `respond`. Respond with the [static response]&#40;/config-1_x_0?id=static-responses&#41;. `static-response` field defines the name of static response. This action will stop processing both rules and handlers)

[comment]: <> (and finish the whole chain with the response.)


[comment]: <> (## URL Paths)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (Exogress use array-based notation for representing paths. Instead of writing the path as a string &#40;/segment1/segment2&#41; it needs to written as an array: `["segment1", "segment2"]`.)

[comment]: <> (This has a lot of benefits - better readability, good looking URL rewrites, and wildcard matching.)

[comment]: <> (### Wildcards)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (If the path may be written as a wildcard &#40;e.g., filter&#41;, special wildcard syntax may be used.)

[comment]: <> (- Single wildcard segment: `["segment1", "?", "segment2"]`)

[comment]: <> (- Multiple wildcard segments: `["segment1", "*", "segment2"]`. Any number of segments may exist between the first and the last one. There may be only one `*` wildcard segment.)

[comment]: <> (- Regular expression: `["/segment\d+/"]`)


[comment]: <> (## Exceptions)

[comment]: <> (?> introduced in 1.0.0)

[comment]: <> (Exceptions are used to stop the processing chain. They may be caught by one of the `catch` blocks.)
